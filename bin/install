#!/bin/sh
set -e
DIR=$(dirname -- "$(readlink -f -- "$BASH_SOURCE")")

# Helper functions
arg_exists() {
  local target_arg="$1"
  shift
  for arg in "$@"; do
    if [[ "$arg" == "$target_arg" ]]; then
      return 0
    fi
  done
  return 1
}

# Helper functions
confirm() {
  local prompt="$1"
  while true; do
    echo "$prompt (y/n): "
    read -r response
    case $response in
      [yY]) return 0 ;;
      [nN]|"") return 1 ;;
      *) echo "Please answer y or n" ;;
    esac
  done
}

# Install Python3.13
sudo nix --extra-experimental-features "nix-command flakes" profile install nixpkgs#python313

if arg_exists "--collect-garbage" "$@"; then
    sudo nix-collect-garbage -d;
fi
if arg_exists "--debug" "$@"; then
    sudo nix --extra-experimental-features "nix-command flakes" run nixpkgs#vscodium -- --no-sandbox --user-data-dir /tmp/vscodium-data --install-extension ms-python.python
    sudo nix --extra-experimental-features "nix-command flakes" run nixpkgs#vscodium -- --no-sandbox --user-data-dir /tmp/vscodium-data /etc/nixos
else
    sudo python3 -B /etc/nixos/bin/scripts/install.py
fi